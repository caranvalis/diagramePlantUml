@startuml UC027
!theme superhero-outline
skinparam backgroundColor #1e1e1e
skinparam actorStyle awesome
skinparam participant {
    BackgroundColor #2d2d2d
    BorderColor #4a90e2
    FontColor #ffffff
}
skinparam sequence {
    ArrowColor #4a90e2
    LifeLineBackgroundColor #2d2d2d
    LifeLineBorderColor #4a90e2
    MessageAlignment center
}

title <color:#4a90e2>UC027 - System d'Alertes Automatiques pour Pi√®ces Manquantes</color>

' Acteurs
actor "<color:#ff6b6b>Manager KYC</color>" as Manager
actor "<color:#ff9ff3>Supervisor KYC</color>" as Supervisor

' Interface Layer
participant "<color:#4ecdc4>API Gateway</color>" as Gateway

' Orchestration Layer
participant "<color:#45b7d1>Orchestrateur KYC</color>" as Orchestrator
participant "<color:#45b7d1>Event Handler</color>" as EventHandler

' Services M√©tier
participant "<color:#96ceb4>Service Alerte</color>" as AlertService
participant "<color:#96ceb4>Service Compl√©tude</color>" as CompletenessService
participant "<color:#96ceb4>Service Priorit√©</color>" as PriorityService
participant "<color:#96ceb4>Service Escalade</color>" as EscalationService

' Services Techniques
participant "<color:#feca57>Service Audit</color>" as AuditService
participant "<color:#ff9ff3>Service Notification</color>" as NotificationService
participant "<color:#ff9ff3>Service Email</color>" as EmailService
participant "<color:#ff9ff3>Service SMS</color>" as SMSService
participant "<color:#54a0ff>Service Cache</color>" as CacheService

' Infrastructure
participant "<color:#5f27cd>Queue Manager</color>" as QueueManager
database "<color:#00d2d3>Base KYC</color>" as KYCDB
database "<color:#ff6348>Audit DB</color>" as AuditDB

== D√©clenchement Automatique ==

note over EventHandler : <color:#ffa726>√âv√©nement d√©tect√© :</color>\n<color:#ffa726>Analyse compl√©tude termin√©e</color>\n<color:#ffa726>‚Üí Pi√®ces manquantes identifi√©es</color>

EventHandler -> EventHandler : <color:#00ff00>R√©ception √©v√©nement DOCUMENTS_MISSING</color>
activate EventHandler

EventHandler -> AuditService : <color:#feca57>Log d√©but processus alerte</color>
activate AuditService
AuditService -> AuditDB : Enregistre d√©but + contexte
AuditService --> EventHandler : <color:#00d2d3>√âv√©nement logged</color>
deactivate AuditService

== Analyse de Criticit√© ==

EventHandler -> CompletenessService : <color:#96ceb4>Analyze impact pi√®ces manquantes</color>
activate CompletenessService

CompletenessService -> CompletenessService : <color:#ffa726>Cat√©goriser documents manquants</color>
CompletenessService -> CompletenessService : <color:#ffa726>√âvaluer impact r√©glementaire</color>
CompletenessService -> CompletenessService : <color:#ffa726>Calculate score urgence</color>

CompletenessService --> EventHandler : <color:#96ceb4>Analyse criticit√© termin√©e</color>
deactivate CompletenessService

EventHandler -> PriorityService : <color:#96ceb4>D√©terminer priorit√© alerte</color>
activate PriorityService

PriorityService -> PriorityService : <color:#ff6b6b>Documents critiques ‚Üí URGENTE</color>
PriorityService -> PriorityService : <color:#ffa726>Documents importants ‚Üí NORMALE</color>
PriorityService -> PriorityService : <color:#00ff00>Documents secondaires ‚Üí FAIBLE</color>

note over PriorityService : <color:#ffa726>**MATRICE DE PRIORIT√â :**</color>\n<color:#ff6b6b>‚Ä¢ URGENTE : CNI, Passeport, K-bis</color>\n<color:#ffa726>‚Ä¢ NORMALE : Justificatifs revenus</color>\n<color:#00ff00>‚Ä¢ FAIBLE : Documents compl√©mentaires</color>

PriorityService --> EventHandler : <color:#96ceb4>Priorit√© : [URGENTE/NORMALE/FAIBLE]</color>
deactivate PriorityService

== G√©n√©ration de l'Alerte ==

EventHandler -> AlertService : <color:#96ceb4>Generate alerte personnalis√©e</color>
activate AlertService

AlertService -> AlertService : <color:#ffa726>Composer message d√©taill√©</color>
AlertService -> AlertService : <color:#ffa726>Inclure √©ch√©ances r√©glementaires</color>
AlertService -> AlertService : <color:#ffa726>Ajouter actions recommand√©es</color>
AlertService -> AlertService : <color:#ffa726>D√©finir canaux selon priorit√©</color>

alt <color:#ff6b6b>Priorit√© URGENTE</color>
    AlertService -> AlertService : <color:#ff6b6b>Activation mode urgence</color>
    AlertService -> AlertService : <color:#ff6b6b>Multi-canal : Email + SMS + Push</color>
    AlertService -> AlertService : <color:#ff6b6b>D√©lai r√©ponse : 2h max</color>
    
else <color:#ffa726>Priorit√© NORMALE</color>
    AlertService -> AlertService : <color:#ffa726>Mode standard</color>
    AlertService -> AlertService : <color:#ffa726>Canal : Email + Push</color>
    AlertService -> AlertService : <color:#ffa726>D√©lai r√©ponse : 24h</color>
    
else <color:#00ff00>Priorit√© FAIBLE</color>
    AlertService -> AlertService : <color:#00ff00>Mode diff√©r√©</color>
    AlertService -> AlertService : <color:#00ff00>Canal : Email uniquement</color>
    AlertService -> AlertService : <color:#00ff00>D√©lai r√©ponse : 72h</color>
end

AlertService --> EventHandler : <color:#96ceb4>Alerte pr√©par√©e</color>
deactivate AlertService

== Envoi Multi-Canal ==

EventHandler -> NotificationService : <color:#96ceb4>Traiter envoi alerte</color>
activate NotificationService

alt <color:#ff6b6b>Mode URGENTE - Multi-canal</color>
    NotificationService -> EmailService : <color:#ff9ff3>Send email urgence</color>
    activate EmailService
    
    alt <color:#ff6b6b>Failure email</color>
        EmailService --> NotificationService : <color:#ff6b6b>Error envoi email</color>
        NotificationService -> QueueManager : <color:#5f27cd>Mettre en file retry urgent</color>
        activate QueueManager
        QueueManager --> NotificationService : <color:#00d2d3>En file prioritaire</color>
        deactivate QueueManager
        
        NotificationService -> AuditService : <color:#feca57>Log √©chec email urgent</color>
        activate AuditService
        AuditService -> AuditDB : Enregistre √©chec + alerte √©quipe
        deactivate AuditService
        
    else <color:#00ff00>Email envoy√©</color>
        EmailService --> NotificationService : <color:#00ff00>Email urgent envoy√©</color>
        
        NotificationService -> AuditService : <color:#feca57>Log succ√®s email urgent</color>
        activate AuditService
        AuditService -> AuditDB : Enregistre succ√®s
        deactivate AuditService
    end
    deactivate EmailService
    
    NotificationService -> SMSService : <color:#ff9ff3>Send SMS urgence</color>
    activate SMSService
    
    alt <color:#ff6b6b>Failure SMS</color>
        SMSService --> NotificationService : <color:#ff6b6b>Error envoi SMS</color>
        NotificationService -> QueueManager : <color:#5f27cd>Retry SMS urgent</color>
        activate QueueManager
        QueueManager --> NotificationService : <color:#00d2d3>En file prioritaire</color>
        deactivate QueueManager
        
    else <color:#00ff00>SMS envoy√©</color>
        SMSService --> NotificationService : <color:#00ff00>SMS urgent envoy√©</color>
        NotificationService -> Manager : <color:#ff6b6b>üö® URGENT : Pi√®ces critiques manquantes</color>
        activate Manager
        
        NotificationService -> AuditService : <color:#feca57>Log succ√®s SMS urgent</color>
        activate AuditService
        AuditService -> AuditDB : Enregistre envoi urgent
        deactivate AuditService
    end
    deactivate SMSService
    
else <color:#ffa726>Mode NORMALE</color>
    NotificationService -> EmailService : <color:#ff9ff3>Send email standard</color>
    activate EmailService
    
    alt <color:#ff6b6b>Failure email</color>
        EmailService --> NotificationService : <color:#ff6b6b>Error envoi</color>
        NotificationService -> QueueManager : <color:#5f27cd>Mettre en file retry</color>
        activate QueueManager
        QueueManager --> NotificationService : <color:#00d2d3>En file d'attente</color>
        deactivate QueueManager
        
    else <color:#00ff00>Email envoy√©</color>
        EmailService --> NotificationService : <color:#00ff00>Email standard envoy√©</color>
        NotificationService -> Manager : <color:#ffa726>üìã Pi√®ces manquantes √† traiter</color>
        
        NotificationService -> AuditService : <color:#feca57>Log succ√®s email standard</color>
        activate AuditService
        AuditService -> AuditDB : Enregistre succ√®s
        deactivate AuditService
    end
    deactivate EmailService
    
else <color:#00ff00>Mode FAIBLE</color>
    NotificationService -> EmailService : <color:#ff9ff3>Send email diff√©r√©</color>
    activate EmailService
    EmailService --> NotificationService : <color:#00ff00>Email diff√©r√© envoy√©</color>
    NotificationService -> Manager : <color:#00ff00>üìÑ Documents compl√©mentaires</color>
    deactivate EmailService
end

== Gestion des Accus√©s de R√©ception ==

alt <color:#00ff00>Manager r√©pond</color>
    Manager -> NotificationService : <color:#00ff00>Accus√© r√©ception + actions pr√©vues</color>
    NotificationService -> AuditService : <color:#feca57>Log accus√© r√©ception</color>
    activate AuditService
    AuditService -> AuditDB : Enregistre r√©ponse + d√©lai
    deactivate AuditService
    
    NotificationService -> KYCDB : <color:#00d2d3>UPDATE alert_status='ACKNOWLEDGED'</color>
    activate KYCDB
    KYCDB --> NotificationService : <color:#00d2d3>Statut mis √† jour</color>
    deactivate KYCDB
    
else <color:#ff6b6b>Pas de r√©ponse dans les d√©lais</color>
    NotificationService -> EscalationService : <color:#96ceb4>D√©clencher escalade</color>
    activate EscalationService
    
    alt <color:#ff6b6b>Alerte URGENTE non trait√©e (> 2h)</color>
        EscalationService -> EscalationService : <color:#ff6b6b>Escalade imm√©diate superviseur</color>
        EscalationService -> NotificationService : <color:#ff9ff3>Alerter superviseur</color>
        NotificationService -> Supervisor : <color:#ff6b6b>üö® ESCALADE : Alerte urgente non trait√©e</color>
        activate Supervisor
        
        EscalationService -> AuditService : <color:#feca57>Log escalade urgente</color>
        activate AuditService
        AuditService -> AuditDB : Enregistre escalade + motif
        deactivate AuditService
        
    else <color:#ffa726>Alerte NORMALE non trait√©e (> 24h)</color>
        EscalationService -> EscalationService : <color:#ffa726>Escalade superviseur</color>
        EscalationService -> NotificationService : <color:#ff9ff3>Relance + superviseur</color>
        NotificationService -> Supervisor : <color:#ffa726>‚ö†Ô∏è Alerte non trait√©e depuis 24h</color>
        
    else <color:#00ff00>Alerte FAIBLE non trait√©e (> 72h)</color>
        EscalationService -> EscalationService : <color:#00ff00>Rappel automatique</color>
        EscalationService -> NotificationService : <color:#ff9ff3>Send rappel</color>
        NotificationService -> Manager : <color:#00ff00>üîî Rappel : Documents en attente</color>
    end
    deactivate EscalationService
end

NotificationService --> EventHandler : <color:#00ff00>Alerte trait√©e</color>
deactivate NotificationService

== Gestion des Reprises ==

EventHandler -> QueueManager : <color:#5f27cd>Traiter files de reprise</color>
activate QueueManager

loop <color:#ffa726>Pour chaque alerte en √©chec</color>
    QueueManager -> QueueManager : <color:#ffa726>Respecter d√©lai entre tentatives</color>
    QueueManager -> NotificationService : <color:#5f27cd>Retry envoi alerte</color>
    activate NotificationService
    
    alt <color:#ff6b6b>Failure apr√®s 3 tentatives</color>
        NotificationService -> AuditService : <color:#feca57>Log √©chec d√©finitif</color>
        activate AuditService
        AuditService -> AuditDB : Enregistre √©chec d√©finitif
        deactivate AuditService
        
        NotificationService -> EscalationService : <color:#96ceb4>Escalade technique</color>
        activate EscalationService
        EscalationService -> Supervisor : <color:#ff6b6b>üîß Probl√®me technique : Alerte non d√©livrable</color>
        deactivate EscalationService
        
    else <color:#00ff00>Success retry</color>
        NotificationService -> AuditService : <color:#feca57>Log succ√®s retry</color>
        activate AuditService
        AuditService -> AuditDB : Enregistre succ√®s apr√®s retry
        deactivate AuditService
    end
    deactivate NotificationService
end
deactivate QueueManager

== Finalisation ==

EventHandler -> KYCDB : <color:#00d2d3>UPDATE client_status='ALERTED', last_alert=NOW()</color>
activate KYCDB
KYCDB --> EventHandler : <color:#00d2d3>Statut client mis √† jour</color>
deactivate KYCDB

EventHandler -> AuditService : <color:#feca57>Log fin processus alerte</color>
activate AuditService
AuditService -> AuditDB : Enregistre fin + statistiques
AuditService --> EventHandler : <color:#00d2d3>Processus audit√©</color>
deactivate AuditService

EventHandler -> EventHandler : <color:#00ff00>Processus alerte termin√©</color>
deactivate EventHandler

note over Manager : <color:#00ff00>Alerte re√ßue selon priorit√©</color>\n<color:#00ff00>et pr√©f√©rences configur√©es</color>
deactivate Manager

note over Supervisor : <color:#ffa726>Supervision des alertes</color>\n<color:#ffa726>et escalades automatiques</color>
deactivate Supervisor

note over AuditDB : <color:#ffa726>**M√âTRIQUES IMPORTANTES :**</color>\n<color:#ffa726>‚Ä¢ Temps de r√©ponse par priorit√©</color>\n<color:#ffa726>‚Ä¢ Taux d'escalade</color>\n<color:#ffa726>‚Ä¢ Efficacit√© des canaux</color>

@enduml
