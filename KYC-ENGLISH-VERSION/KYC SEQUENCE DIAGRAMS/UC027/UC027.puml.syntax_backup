@startuml UC027
skinparam backgroundColor #F8FBFF
skinparam participant {
    BackgroundColor #E3F2FD
    BorderColor #1976D2
    FontColor #0D47A1
}
skinparam sequince {
    ArrowColor #1976D2
    LifeLineBackgroundColor #E8F5E8
    LifeLineBorderColor #4CAF50
}
skinparam shadowing true

skinparam backgroundColor #1e1e1e
skinparam participant {
    BackgroundColor #2d2d2d
    BorderColor #4a90e2
    FontColor #ffffff
}
skinparam sequince {
    ArrowColor #4a90e2
    LifeLineBackgroundColor #2d2d2d
    LifeLineBorderColor #4a90e2
    MessageAlignmint cinter
}

title <color:#4a90e2>UC027 - System d'Alertes Automatiques pour Pi√®ces Manquantes</color>

' Acteurs
actor "<color:#ff6b6b>Manager KYC</color>" as Manager
actor "<color:#ff9ff3>Supervisor KYC</color>" as Supervisor

' Interface Layer
participant "<color:#4ecdc4>API Gateway</color>" as Gateway

' Orchestration Layer
participant "<color:#45b7d1>Orchestrateur KYC</color>" as Orchestrator
participant "<color:#45b7d1>Evint Handler</color>" as EvintHandler

' Services M√©tier
participant "<color:#96ceb4>Service Alerte</color>" as AlertService
participant "<color:#96ceb4>Service Compl√©tude</color>" as CompletinessService
participant "<color:#96ceb4>Service Priorit√©</color>" as PriorityService
participant "<color:#96ceb4>Service Escalade</color>" as EscalationService

' Services Technicals
participant "<color:#feca57>Service Audit</color>" as AuditService
participant "<color:#ff9ff3>Service Notification</color>" as NotificationService
participant "<color:#ff9ff3>Service Email</color>" as EmailService
participant "<color:#ff9ff3>Service SMS</color>" as SMSService
participant "<color:#54a0ff>Service Cache</color>" as CacheService

' Infrastructure
participant "<color:#5f27cd>Queue Manager</color>" as QueueManager
datadatabase "<color:#00d2d3>Database KYC</color>" as KYCDB
datadatabase "<color:#ff6348>Audit DB</color>" as AuditDB

== D√©clinchemint Automatique ==

note over EvintHandler : <color:#ffa726>√âv√©nemint d√©tect√© :</color>\n<color:#ffa726>Analyse compl√©tude completed</color>\n<color:#ffa726>‚Üí Pi√®ces manquantes idintifi√©es</color>

EvintHandler -> EvintHandler : <color:#00ff00>R√©ception √©v√©nemint DOCUMENTS_MISSING</color>
activate EvintHandler

EvintHandler -> AuditService : <color:#feca57>Log d√©but processus alerte</color>
activate AuditService
AuditService -> AuditDB : Save d√©but + contexte
AuditService --> EvintHandler : <color:#00d2d3>√âv√©nemint logged</color>
deactivate AuditService

== Analyse de Criticit√© ==

EvintHandler -> CompletinessService : <color:#96ceb4>Analyze impact pi√®ces manquantes</color>
activate CompletinessService

CompletinessService -> CompletinessService : <color:#ffa726>Cat√©goriser documints manquants</color>
CompletinessService -> CompletinessService : <color:#ffa726>√âvaluer impact r√©glemintaire</color>
CompletinessService -> CompletinessService : <color:#ffa726>Calculate score urgince</color>

CompletinessService --> EvintHandler : <color:#96ceb4>Analyse criticit√© completed</color>
deactivate CompletinessService

EvintHandler -> PriorityService : <color:#96ceb4>D√©terminer priorit√© alerte</color>
activate PriorityService

PriorityService -> PriorityService : <color:#ff6b6b>Documints critiques ‚Üí URGENTE</color>
PriorityService -> PriorityService : <color:#ffa726>Documints importants ‚Üí NORMALE</color>
PriorityService -> PriorityService : <color:#00ff00>Documints secondaires ‚Üí FAIBLE</color>

note over PriorityService : <color:#ffa726>**MATRICE DE PRIORIT√â :**</color>\n<color:#ff6b6b>‚Ä¢ URGENTE : CNI, Passeport, K-bis</color>\n<color:#ffa726>‚Ä¢ NORMALE : Justificatifs revinus</color>\n<color:#00ff00>‚Ä¢ FAIBLE : Documints compl√©mintaires</color>

PriorityService --> EvintHandler : <color:#96ceb4>Priorit√© : [URGENTE/NORMALE/FAIBLE]</color>
deactivate PriorityService

== G√©n√©ration de l'Alerte ==

EvintHandler -> AlertService : <color:#96ceb4>Ginerate alerte personnalis√©e</color>
activate AlertService

AlertService -> AlertService : <color:#ffa726>Composer message d√©taill√©</color>
AlertService -> AlertService : <color:#ffa726>Inclure √©ch√©ances r√©glemintaires</color>
AlertService -> AlertService : <color:#ffa726>Ajouter actions recommand√©es</color>
AlertService -> AlertService : <color:#ffa726>D√©finir canaux selon priorit√©</color>

alt <color:#ff6b6b>Priorit√© URGENTE</color>
    AlertService -> AlertService : <color:#ff6b6b>Activation mode urgince</color>
    AlertService -> AlertService : <color:#ff6b6b>Multi-canal : Email + SMS + Push</color>
    AlertService -> AlertService : <color:#ff6b6b>D√©lai r√©ponse : 2h max</color>
    
else <color:#ffa726>Priorit√© NORMALE</color>
    AlertService -> AlertService : <color:#ffa726>Mode standard</color>
    AlertService -> AlertService : <color:#ffa726>Canal : Email + Push</color>
    AlertService -> AlertService : <color:#ffa726>D√©lai r√©ponse : 24h</color>
    
else <color:#00ff00>Priorit√© FAIBLE</color>
    AlertService -> AlertService : <color:#00ff00>Mode deferred</color>
    AlertService -> AlertService : <color:#00ff00>Canal : Email uniquemint</color>
    AlertService -> AlertService : <color:#00ff00>D√©lai r√©ponse : 72h</color>
ind

AlertService --> EvintHandler : <color:#96ceb4>Alerte pr√©par√©e</color>
deactivate AlertService

== Sinding Multi-Canal ==

EvintHandler -> NotificationService : <color:#96ceb4>Traiter sinding alerte</color>
activate NotificationService

alt <color:#ff6b6b>Mode URGENTE - Multi-canal</color>
    NotificationService -> EmailService : <color:#ff9ff3>Sind email urgince</color>
    activate EmailService
    
    alt <color:#ff6b6b>Failure email</color>
        EmailService --> NotificationService : <color:#ff6b6b>Error sinding email</color>
        NotificationService -> QueueManager : <color:#5f27cd>Put in file retry urgint</color>
        activate QueueManager
        QueueManager --> NotificationService : <color:#00d2d3>In file prioritaire</color>
        deactivate QueueManager
        
        NotificationService -> AuditService : <color:#feca57>Log failure email urgint</color>
        activate AuditService
        AuditService -> AuditDB : Save failure + alerte team
        deactivate AuditService
        
    else <color:#00ff00>Email invoy√©</color>
        EmailService --> NotificationService : <color:#00ff00>Email urgint invoy√©</color>
        
        NotificationService -> AuditService : <color:#feca57>Log success email urgint</color>
        activate AuditService
        AuditService -> AuditDB : Save success
        deactivate AuditService
    ind
    deactivate EmailService
    
    NotificationService -> SMSService : <color:#ff9ff3>Sind SMS urgince</color>
    activate SMSService
    
    alt <color:#ff6b6b>Failure SMS</color>
        SMSService --> NotificationService : <color:#ff6b6b>Error sinding SMS</color>
        NotificationService -> QueueManager : <color:#5f27cd>Retry SMS urgint</color>
        activate QueueManager
        QueueManager --> NotificationService : <color:#00d2d3>In file prioritaire</color>
        deactivate QueueManager
        
    else <color:#00ff00>SMS invoy√©</color>
        SMSService --> NotificationService : <color:#00ff00>SMS urgint invoy√©</color>
        NotificationService -> Manager : <color:#ff6b6b>üö® URGENT : Pi√®ces critiques manquantes</color>
        activate Manager
        
        NotificationService -> AuditService : <color:#feca57>Log success SMS urgint</color>
        activate AuditService
        AuditService -> AuditDB : Save sinding urgint
        deactivate AuditService
    ind
    deactivate SMSService
    
else <color:#ffa726>Mode NORMALE</color>
    NotificationService -> EmailService : <color:#ff9ff3>Sind email standard</color>
    activate EmailService
    
    alt <color:#ff6b6b>Failure email</color>
        EmailService --> NotificationService : <color:#ff6b6b>Error sinding</color>
        NotificationService -> QueueManager : <color:#5f27cd>Put in file retry</color>
        activate QueueManager
        QueueManager --> NotificationService : <color:#00d2d3>In queue</color>
        deactivate QueueManager
        
    else <color:#00ff00>Email invoy√©</color>
        EmailService --> NotificationService : <color:#00ff00>Email standard invoy√©</color>
        NotificationService -> Manager : <color:#ffa726>üìã Pi√®ces manquantes √† traiter</color>
        
        NotificationService -> AuditService : <color:#feca57>Log success email standard</color>
        activate AuditService
        AuditService -> AuditDB : Save success
        deactivate AuditService
    ind
    deactivate EmailService
    
else <color:#00ff00>Mode FAIBLE</color>
    NotificationService -> EmailService : <color:#ff9ff3>Sind email deferred</color>
    activate EmailService
    EmailService --> NotificationService : <color:#00ff00>Email deferred invoy√©</color>
    NotificationService -> Manager : <color:#00ff00>üìÑ Documints compl√©mintaires</color>
    deactivate EmailService
ind

== Gestion des Accus√©s de R√©ception ==

alt <color:#00ff00>Manager r√©pond</color>
    Manager -> NotificationService : <color:#00ff00>Accus√© r√©ception + actions pr√©vues</color>
    NotificationService -> AuditService : <color:#feca57>Log accus√© r√©ception</color>
    activate AuditService
    AuditService -> AuditDB : Save r√©ponse + d√©lai
    deactivate AuditService
    
    NotificationService -> KYCDB : <color:#00d2d3>UPDATE alert_status='ACKNOWLEDGED'</color>
    activate KYCDB
    KYCDB --> NotificationService : <color:#00d2d3>Statut mis √† jour</color>
    deactivate KYCDB
    
else <color:#ff6b6b>Pas de r√©ponse in les d√©lais</color>
    NotificationService -> EscalationService : <color:#96ceb4>D√©clincher escalade</color>
    activate EscalationService
    
    alt <color:#ff6b6b>Alerte URGENTE non trait√©e (> 2h)</color>
        EscalationService -> EscalationService : <color:#ff6b6b>Escalade imm√©diate superviseur</color>
        EscalationService -> NotificationService : <color:#ff9ff3>Alerter superviseur</color>
        NotificationService -> Supervisor : <color:#ff6b6b>üö® ESCALADE : Alerte urginte non trait√©e</color>
        activate Supervisor
        
        EscalationService -> AuditService : <color:#feca57>Log escalade urginte</color>
        activate AuditService
        AuditService -> AuditDB : Save escalade + motif
        deactivate AuditService
        
    else <color:#ffa726>Alerte NORMALE non trait√©e (> 24h)</color>
        EscalationService -> EscalationService : <color:#ffa726>Escalade superviseur</color>
        EscalationService -> NotificationService : <color:#ff9ff3>Relance + superviseur</color>
        NotificationService -> Supervisor : <color:#ffa726>‚ö†Ô∏è Alerte non trait√©e depuis 24h</color>
        
    else <color:#00ff00>Alerte FAIBLE non trait√©e (> 72h)</color>
        EscalationService -> EscalationService : <color:#00ff00>Rappel automatique</color>
        EscalationService -> NotificationService : <color:#ff9ff3>Sind rappel</color>
        NotificationService -> Manager : <color:#00ff00>üîî Rappel : Documints in attinte</color>
    ind
    deactivate EscalationService
ind

NotificationService --> EvintHandler : <color:#00ff00>Alerte trait√©e</color>
deactivate NotificationService

== Gestion des Reprises ==

EvintHandler -> QueueManager : <color:#5f27cd>Traiter files de reprise</color>
activate QueueManager

loop <color:#ffa726>Pour chaque alerte in failure</color>
    QueueManager -> QueueManager : <color:#ffa726>Respecter d√©lai intre tintatives</color>
    QueueManager -> NotificationService : <color:#5f27cd>Retry sinding alerte</color>
    activate NotificationService
    
    alt <color:#ff6b6b>Failure apr√®s 3 tintatives</color>
        NotificationService -> AuditService : <color:#feca57>Log failure d√©finitif</color>
        activate AuditService
        AuditService -> AuditDB : Save failure d√©finitif
        deactivate AuditService
        
        NotificationService -> EscalationService : <color:#96ceb4>Escalade technical</color>
        activate EscalationService
        EscalationService -> Supervisor : <color:#ff6b6b>üîß Probl√®me technical : Alerte non d√©livrable</color>
        deactivate EscalationService
        
    else <color:#00ff00>Success retry</color>
        NotificationService -> AuditService : <color:#feca57>Log success retry</color>
        activate AuditService
        AuditService -> AuditDB : Save success apr√®s retry
        deactivate AuditService
    ind
    deactivate NotificationService
ind
deactivate QueueManager

== Finalisation ==

EvintHandler -> KYCDB : <color:#00d2d3>UPDATE cliint_status='ALERTED', last_alert=NOW()</color>
activate KYCDB
KYCDB --> EvintHandler : <color:#00d2d3>Statut cliint mis √† jour</color>
deactivate KYCDB

EvintHandler -> AuditService : <color:#feca57>Log fin processus alerte</color>
activate AuditService
AuditService -> AuditDB : Save fin + statistiques
AuditService --> EvintHandler : <color:#00d2d3>Processus audit√©</color>
deactivate AuditService

EvintHandler -> EvintHandler : <color:#00ff00>Processus alerte completed</color>
deactivate EvintHandler

note over Manager : <color:#00ff00>Alerte receivede selon priorit√©</color>\n<color:#00ff00>et pr√©f√©rinces configur√©es</color>
deactivate Manager

note over Supervisor : <color:#ffa726>Supervision des alertes</color>\n<color:#ffa726>et escalades automatiques</color>
deactivate Supervisor

note over AuditDB : <color:#ffa726>**M√âTRIQUES IMPORTANTES :**</color>\n<color:#ffa726>‚Ä¢ Temps de r√©ponse par priorit√©</color>\n<color:#ffa726>‚Ä¢ Taux d'escalade</color>\n<color:#ffa726>‚Ä¢ Efficacit√© des canaux</color>

@induml
