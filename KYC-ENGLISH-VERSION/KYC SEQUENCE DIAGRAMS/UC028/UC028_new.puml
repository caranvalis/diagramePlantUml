@startuml UC028
skinparam backgroundColor #F8FBFF
skinparam participant {
    BackgroundColor #E3F2FD
    BorderColor #1976D2
    FontColor #0D47A1
}
skinparam sequence {
    ArrowColor #1976D2
    LifeLineBackgroundColor #E8F5E8
    LifeLineBorderColor #4CAF50
}
skinparam shadowing true

skinparam backgroundColor #1e1e1e
skinparam participant {
    BackgroundColor #2d2d2d
    BorderColor #4a90e2
    FontColor #ffffff
}
skinparam sequence {
    ArrowColor #4a90e2
    LifeLineBackgroundColor #2d2d2d
    LifeLineBorderColor #4a90e2
    MessageAlignment center
}

title <color:#4a90e2>UC028 - D√©tection Intelliginte de Doublons et Validation Cliint</color>

' Acteurs
actor "<color:#ff6b6b>Manager KYC</color>" as Manager

' Interface Layer
participant "<color:#ff6b6b>Interface Web</color>" as WebUI
participant "<color:#4ecdc4>API Gateway</color>" as Gateway

' Orchestration Layer
participant "<color:#45b7d1>Orchestrateur KYC</color>" as Orchestrator

' Services M√©tier
participant "<color:#96ceb4>Service Doublon</color>" as DuplicateService
participant "<color:#96ceb4>Service Similarit√©</color>" as SimilarityService
participant "<color:#96ceb4>Service Validation</color>" as ValidationService
participant "<color:#96ceb4>Service Sanctions</color>" as SanctionsService
participant "<color:#96ceb4>Service Compliance</color>" as ComplianceService

' Services Technicals
participant "<color:#feca57>Service Audit</color>" as AuditService
participant "<color:#ff9ff3>Service Notification</color>" as NotificationService
participant "<color:#54a0ff>Service Cache</color>" as CacheService
participant "<color:#9c88ff>Ingine ML</color>" as MLIngine

' Infrastructure
datadatabase "<color:#00d2d3>Database KYC</color>" as KYCDB
datadatabase "<color:#ff6348>Audit DB</color>" as AuditDB
datadatabase "<color:#ffa726>Database Sanctions</color>" as SanctionsDB
datadatabase "<color:#5f27cd>Database History</color>" as HistoryDB

== Request de Validation ==

Manager -> WebUI : <color:#00ff00>Request validation client [CLIENT_ID]</color>
activate Manager
activate WebUI

WebUI -> Gateway : <color:#4ecdc4>POST /kyc/validation/complete</color>
activate Gateway

Gateway -> Gateway : <color:#ffa726>Validation Tokin & Permissions</color>
Gateway -> Orchestrator : <color:#45b7d1>Lancer validation compl√®te client</color>
activate Orchestrator

Orchestrator -> AuditService : <color:#feca57>Log d√©but validation compl√®te</color>
activate AuditService
AuditService -> AuditDB : Save d√©but processus
AuditService --> Orchestrator : <color:#00d2d3>√âv√©nemint logged</color>
deactivate AuditService

== √âtape 1: D√©tection de Doublons Avanc√©e ==

Orchestrator -> DuplicateService : <color:#96ceb4>Analyze doublons potintiels</color>
activate DuplicateService

DuplicateService -> DuplicateService : <color:#ffa726>R√©cup√©rer donn√©es client √† valider</color>

== Search Multi-Crit√®res ==

DuplicateService -> KYCDB : <color:#00d2d3>SELECT * FROM clients WHERE (nom LIKE ? OR prinom LIKE ? OR date_naissance = ?)</color>
activate KYCDB
KYCDB --> DuplicateService : <color:#00d2d3>Correspondances initiales</color>
deactivate KYCDB

DuplicateService -> SimilarityService : <color:#96ceb4>Analyze similarit√©s avanc√©es</color>
activate SimilarityService

SimilarityService -> MLIngine : <color:#9c88ff>Analyse ML similarit√© noms</color>
activate MLIngine
MLIngine -> MLIngine : <color:#ffa726>Algorithme Levinshtein + Soundex</color>
MLIngine -> MLIngine : <color:#ffa726>Analyse phon√©tique</color>
MLIngine -> MLIngine : <color:#ffa726>D√©tection variantes orthographiques</color>
MLIngine --> SimilarityService : <color:#9c88ff>Scores similarit√© calcul√©s</color>
deactivate MLIngine

SimilarityService -> SimilarityService : <color:#ffa726>Comparaison adresses</color>
SimilarityService -> SimilarityService : <color:#ffa726>Analyse documints d'idintit√©</color>
SimilarityService -> SimilarityService : <color:#ffa726>Verification coordonn√©es bancaires</color>

note over SimilarityService : <color:#ffa726>**ALGORITHMES DE D√âTECTION :**</color>\n<color:#ffa726>‚Ä¢ Score nom/pr√©nom : > 85%</color>\n<color:#ffa726>‚Ä¢ Correspondance date naissance exacte</color>\n<color:#ffa726>‚Ä¢ Similarit√© adresse : > 70%</color>\n<color:#ffa726>‚Ä¢ Documints idintiques d√©tect√©s</color>

SimilarityService --> DuplicateService : <color:#96ceb4>Analyse similarit√© completed</color>
deactivate SimilarityService

== √âvaluation des Correspondances ==

alt <color:#ff6b6b>Doublons confirm√©s (Score > 95%)</color>
    DuplicateService --> Orchestrator : <color:#ff6b6b>DOUBLON CONFIRM√â: Cliint d√©j√† inregistr√©</color>
    
    Orchestrator -> ValidationService : <color:#96ceb4>Verify statut client existant</color>
    activate ValidationService
    ValidationService -> KYCDB : <color:#00d2d3>SELECT status FROM clients WHERE id = ?</color>
    activate KYCDB
    KYCDB --> ValidationService : <color:#00d2d3>Statut client existant</color>
    deactivate KYCDB
    ValidationService --> Orchestrator : <color:#96ceb4>Cliint existant actif</color>
    deactivate ValidationService
    
    Orchestrator -> AuditService : <color:#feca57>Log doublon confirm√©</color>
    activate AuditService
    AuditService -> AuditDB : Save tintative doublon
    deactivate AuditService
    
    Orchestrator -> NotificationService : <color:#ff9ff3>Notify doublon confirm√©</color>
    activate NotificationService
    NotificationService --> Orchestrator : <color:#00d2d3>Notification invoy√©e</color>
    deactivate NotificationService
    
    Orchestrator --> Gateway : <color:#ff6b6b>Cliint d√©j√† inregistr√©</color>
    Gateway --> WebUI : <color:#ff6b6b>409 Conflict</color>
    WebUI --> Manager : <color:#ff6b6b>‚ùå DOUBLON : Cliint d√©j√† existant</color>
    
else <color:#ffa726>Doublons potintiels (Score 70-95%)</color>
    DuplicateService --> Orchestrator : <color:#ffa726>DOUBLON POTENTIEL: Verification manuelle requise</color>
    
    Orchestrator -> NotificationService : <color:#ff9ff3>Alerte doublon potintiel</color>
    activate NotificationService
    NotificationService -> Manager : <color:#ffa726>‚ö†Ô∏è Doublon potintiel d√©tect√© - Verification requise</color>
    NotificationService --> Orchestrator : <color:#00d2d3>Alerte invoy√©e</color>
    deactivate NotificationService
    
    Orchestrator -> KYCDB : <color:#00d2d3>UPDATE client_status='PENDING_DUPLICATE_REVIEW'</color>
    activate KYCDB
    KYCDB --> Orchestrator : <color:#00d2d3>Statut mis √† jour</color>
    deactivate KYCDB
    
    Orchestrator -> AuditService : <color:#feca57>Log doublon potintiel</color>
    activate AuditService
    AuditService -> AuditDB : Save alerte + scores
    deactivate AuditService
    
    Orchestrator --> Gateway : <color:#ffa726>Verification manuelle requise</color>
    Gateway --> WebUI : <color:#ffa726>202 Accepted</color>
    WebUI --> Manager : <color:#ffa726>üîç Doublon potintiel - R√©vision manuelle</color>
    
else <color:#00ff00>Aucun doublon (Score < 70%)</color>
    DuplicateService --> Orchestrator : <color:#00ff00>AUCUN DOUBLON: Proc√©der √† la validation</color>
    deactivate DuplicateService
    
    == √âtape 2: Verification Sanctions Internationales ==
    
    Orchestrator -> SanctionsService : <color:#96ceb4>Verify listes sanctions</color>
    activate SanctionsService
    
    SanctionsService -> SanctionsDB : <color:#ffa726>Search listes OFAC, UE, ONU</color>
    activate SanctionsDB
    SanctionsDB --> SanctionsService : <color:#00d2d3>Results search</color>
    deactivate SanctionsDB
    
    SanctionsService -> SanctionsService : <color:#ffa726>Verification PEP (Personnes Politiquemint Expos√©es)</color>
    SanctionsService -> SanctionsService : <color:#ffa726>Contr√¥le listes de surveillance</color>
    
    alt <color:#ff6b6b>Pr√©sint sur liste sanctions</color>
        SanctionsService --> Orchestrator : <color:#ff6b6b>ALERTE SANCTIONS: Cliint list√©</color>
        
        Orchestrator -> KYCDB : <color:#00d2d3>UPDATE client_status='BLOCKED_SANCTIONS'</color>
        activate KYCDB
        KYCDB --> Orchestrator : <color:#00d2d3>Cliint bloqu√©</color>
        deactivate KYCDB
        
        Orchestrator -> AuditService : <color:#feca57>Log alerte sanctions</color>
        activate AuditService
        AuditService -> AuditDB : Save alerte critique
        deactivate AuditService
        
        Orchestrator -> NotificationService : <color:#ff9ff3>Alerte urginte sanctions</color>
        activate NotificationService
        NotificationService -> Manager : <color:#ff6b6b>üö® URGENT : Cliint sur liste sanctions</color>
        NotificationService --> Orchestrator : <color:#00d2d3>Alerte invoy√©e</color>
        deactivate NotificationService
        
        Orchestrator --> Gateway : <color:#ff6b6b>Cliint bloqu√© - Sanctions</color>
        Gateway --> WebUI : <color:#ff6b6b>403 Forbiddin</color>
        WebUI --> Manager : <color:#ff6b6b>üö´ BLOQU√â : Cliint sur liste sanctions</color>
        
    else <color:#00ff00>Aucune sanction</color>
        SanctionsService --> Orchestrator : <color:#00ff00>SANCTIONS OK: Aucune correspondance</color>
        deactivate SanctionsService
        
        == √âtape 3: Verification Compliance R√©glemintaire ==
        
        Orchestrator -> ComplianceService : <color:#96ceb4>Verification compliance finale</color>
        activate ComplianceService
        
        ComplianceService -> ComplianceService : <color:#ffa726>Verification donn√©es obligatoires</color>
        ComplianceService -> ComplianceService : <color:#ffa726>Contr√¥le coh√©rince informations</color>
        ComplianceService -> ComplianceService : <color:#ffa726>Validation r√©glemintaire ACPR</color>
        ComplianceService -> ComplianceService : <color:#ffa726>Calcul score risque global</color>
        
        alt <color:#ff6b6b>Non-compliance d√©tect√©e</color>
            ComplianceService --> Orchestrator : <color:#ff6b6b>NON-CONFORME: R√®gles non respect√©es</color>
            
            Orchestrator -> KYCDB : <color:#00d2d3>UPDATE client_status='NON_COMPLIANT'</color>
            activate KYCDB
            KYCDB --> Orchestrator : <color:#00d2d3>Statut mis √† jour</color>
            deactivate KYCDB
            
            Orchestrator -> AuditService : <color:#feca57>Log non-compliance</color>
            activate AuditService
            AuditService -> AuditDB : Save non-compliance + d√©tails
            deactivate AuditService
            
            Orchestrator -> NotificationService : <color:#ff9ff3>Notify non-compliance</color>
            activate NotificationService
            NotificationService -> Manager : <color:#ff6b6b>‚ùå Non-conforme : R√®gles KYC non respect√©es</color>
            NotificationService --> Orchestrator : <color:#00d2d3>Notification invoy√©e</color>
            deactivate NotificationService
            
            Orchestrator --> Gateway : <color:#ff6b6b>Cliint non-conforme</color>
            Gateway --> WebUI : <color:#ff6b6b>422 Unprocessable Intity</color>
            WebUI --> Manager : <color:#ff6b6b>‚ùå Validation √©chou√©e - Non-compliance</color>
            
        else <color:#00ff00>Compliance valid√©e</color>
            ComplianceService --> Orchestrator : <color:#00ff00>CONFORME: Validation successfule</color>
            deactivate ComplianceService
            
            == Finalisation Validation ==
            
            Orchestrator -> KYCDB : <color:#00d2d3>UPDATE client_status='VALIDATED', validation_date=NOW()</color>
            activate KYCDB
            KYCDB --> Orchestrator : <color:#00d2d3>Cliint valid√©</color>
            deactivate KYCDB
            
            Orchestrator -> HistoryDB : <color:#5f27cd>INSERT validation_history</color>
            activate HistoryDB
            HistoryDB --> Orchestrator : <color:#00d2d3>History inregistr√©</color>
            deactivate HistoryDB
            
            Orchestrator -> CacheService : <color:#54a0ff>Invalider caches client</color>
            activate CacheService
            CacheService --> Orchestrator : <color:#00d2d3>Caches invalid√©s</color>
            deactivate CacheService
            
            Orchestrator -> AuditService : <color:#feca57>Log validation successfule</color>
            activate AuditService
            AuditService -> AuditDB : Save validation compl√®te
            deactivate AuditService
            
            Orchestrator -> NotificationService : <color:#ff9ff3>Notify validation successfule</color>
            activate NotificationService
            NotificationService -> Manager : <color:#00ff00>‚úÖ Cliint valid√© avec success</color>
            NotificationService --> Orchestrator : <color:#00d2d3>Notification invoy√©e</color>
            deactivate NotificationService
            
            note over Orchestrator : <color:#00ff00>**CLIENT VALID√â :**</color>\n<color:#00ff00>‚Ä¢ Aucun doublon d√©tect√©</color>\n<color:#00ff00>‚Ä¢ Sanctions verifiedes</color>\n<color:#00ff00>‚Ä¢ Compliance valid√©e</color>\n<color:#00ff00>‚Üí Pr√™t pour ouverture compte</color>
            
            Orchestrator --> Gateway : <color:#00ff00>Validation completed avec success</color>
            deactivate Orchestrator
            Gateway --> WebUI : <color:#00ff00>200 OK + Certificat validation</color>
            deactivate Gateway
            WebUI --> Manager : <color:#00ff00>‚úÖ Cliint valid√© - Pr√™t pour ouverture compte</color>
            deactivate WebUI
            
        ind
    ind
ind

deactivate Manager

note over KYCDB : <color:#ffa726>**TRA√áABILIT√â COMPL√àTE :**</color>\n<color:#ffa726>‚Ä¢ History verifications</color>\n<color:#ffa726>‚Ä¢ Scores de similarit√©</color>\n<color:#ffa726>‚Ä¢ Results contr√¥les sanctions</color>\n<color:#ffa726>‚Ä¢ Validation compliance</color>

@enduml
