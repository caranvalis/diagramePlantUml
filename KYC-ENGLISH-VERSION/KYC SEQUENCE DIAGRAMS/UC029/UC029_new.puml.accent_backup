@startuml UC029
skinparam backgroundColor #F8FBFF
skinparam participant {
    BackgroundColor #E3F2FD
    BorderColor #1976D2
    FontColor #0D47A1
}
skinparam sequence {
    ArrowColor #1976D2
    LifeLineBackgroundColor #E8F5E8
    LifeLineBorderColor #4CAF50
}
skinparam shadowing true

skinparam backgroundColor #1e1e1e
skinparam participant {
    BackgroundColor #2d2d2d
    BorderColor #4a90e2
    FontColor #ffffff
}
skinparam sequence {
    ArrowColor #4a90e2
    LifeLineBackgroundColor #2d2d2d
    LifeLineBorderColor #4a90e2
    MessageAlignment center
}

title <color:#4a90e2>UC029 - V√©rification Multi-Sources des Listes Noires et Sanctions</color>

' Acteurs
actor "<color:#ff6b6b>Manager KYC</color>" as Manager
actor "<color:#ff9ff3>Analyste Conformit√©</color>" as Analyste

' Interface Layer
participant "<color:#4ecdc4>API Gateway</color>" as Gateway

' Orchestration Layer
participant "<color:#45b7d1>Orchestrateur KYC</color>" as Orchestrator

' Services M√©tier
participant "<color:#96ceb4>Service Blacklist</color>" as BlacklistService
participant "<color:#96ceb4>Service Sanctions</color>" as SanctionsService
participant "<color:#96ceb4>Service Scoring</color>" as ScoringService
participant "<color:#96ceb4>Service PEP</color>" as PEPService

' Services Techniques
participant "<color:#feca57>Service Audit</color>" as AuditService
participant "<color:#ff9ff3>Service Notification</color>" as NotificationService
participant "<color:#54a0ff>Service Cache</color>" as CacheService
participant "<color:#9c88ff>Service Monitoring</color>" as MonitoringService

' APIs Externes
participant "<color:#ffa726>API OFAC</color>" as OFACAPI
participant "<color:#ffa726>API Union Europ√©enne</color>" as EUAPI
participant "<color:#ffa726>API ONU</color>" as UNAPI
participant "<color:#ffa726>API ACPR</color>" as ACPRAPI
participant "<color:#ffa726>API World-Check</color>" as WorldCheckAPI

' Infrastructure
database "<color:#00d2d3>Base KYC</color>" as KYCDB
database "<color:#ff6348>Audit DB</color>" as AuditDB
database "<color:#5f27cd>Cache Blacklist</color>" as BlacklistCache

== D√©clenchement de la V√©rification ==

note over Orchestrator : <color:#ffa726>D√©clenchement automatique lors de :</color>\n<color:#ffa726>‚Ä¢ Cr√©ation nouveau client</color>\n<color:#ffa726>‚Ä¢ Mise √† jour donn√©es client</color>\n<color:#ffa726>‚Ä¢ V√©rification p√©riodique</color>

Orchestrator -> BlacklistService : <color:#96ceb4>Verify client contre toutes les listes [CLIENT_ID]</color>
activate Orchestrator
activate BlacklistService

BlacklistService -> AuditService : <color:#feca57>Log d√©but v√©rification blacklist</color>
activate AuditService
AuditService -> AuditDB : Enregistre d√©but + donn√©es client
AuditService --> BlacklistService : <color:#00d2d3>√âv√©nement logged</color>
deactivate AuditService

== V√©rification Cache ==

BlacklistService -> CacheService : <color:#54a0ff>Verify cache r√©cent client</color>
activate CacheService

CacheService -> BlacklistCache : <color:#5f27cd>SELECT * FROM blacklist_cache WHERE client_id=? AND created_at > NOW() - INTERVAL 24 HOUR</color>
activate BlacklistCache

alt <color:#00ff00>Cache valide trouv√©</color>
    BlacklistCache --> CacheService : <color:#00d2d3>R√©sultats cache (< 24h)</color>
    CacheService --> BlacklistService : <color:#54a0ff>R√©sultats en cache</color>
    
    BlacklistService -> AuditService : <color:#feca57>Log utilisation cache</color>
    activate AuditService
    AuditService -> AuditDB : Enregistre cache hit
    deactivate AuditService
    
    BlacklistService --> Orchestrator : <color:#00ff00>R√©sultats cache valid√©s</color>
    
else <color:#ff6348>Cache expir√© ou absent</color>
    BlacklistCache --> CacheService : <color:#ff6348>Pas de cache valide</color>
    deactivate BlacklistCache
    CacheService --> BlacklistService : <color:#ff6348>V√©rification APIs requise</color>
    deactivate CacheService
    
    == V√©rifications Multi-Sources ==
    
    note over BlacklistService : <color:#ffa726>**V√âRIFICATION PARALL√àLE :**</color>\n<color:#ffa726>Interrogation simultan√©e de toutes les sources</color>\n<color:#ffa726>pour optimiser les performances</color>
    
    par <color:#ffa726>V√©rification OFAC (USA)</color>
        BlacklistService -> MonitoringService : <color:#9c88ff>Monitor API OFAC</color>
        activate MonitoringService
        MonitoringService --> BlacklistService : <color:#00d2d3>API OFAC disponible</color>
        deactivate MonitoringService
        
        BlacklistService -> OFACAPI : <color:#ffa726>Recherche sanctions US</color>
        activate OFACAPI
        
        alt <color:#ff6b6b>API OFAC indisponible</color>
            OFACAPI --> BlacklistService : <color:#ff6b6b>Timeout/Error</color>
            BlacklistService -> AuditService : <color:#feca57>Log indisponibilit√© OFAC</color>
            activate AuditService
            AuditService -> AuditDB : Enregistre incident API
            deactivate AuditService
            
            BlacklistService -> NotificationService : <color:#ff9ff3>Alerte technique OFAC</color>
            activate NotificationService
            NotificationService --> BlacklistService : <color:#00d2d3>√âquipe technique alert√©e</color>
            deactivate NotificationService
            
        else <color:#00ff00>R√©sultat OFAC re√ßu</color>
            OFACAPI --> BlacklistService : <color:#00ff00>R√©sultat OFAC + score match</color>
        end
        deactivate OFACAPI
        
    and <color:#ffa726>V√©rification Union Europ√©enne</color>
        BlacklistService -> EUAPI : <color:#ffa726>Recherche sanctions UE</color>
        activate EUAPI
        
        alt <color:#ff6b6b>API UE indisponible</color>
            EUAPI --> BlacklistService : <color:#ff6b6b>Error UE</color>
            BlacklistService -> AuditService : <color:#feca57>Log indisponibilit√© UE</color>
            activate AuditService
            AuditService -> AuditDB : Enregistre incident
            deactivate AuditService
            
        else <color:#00ff00>R√©sultat UE re√ßu</color>
            EUAPI --> BlacklistService : <color:#00ff00>R√©sultat UE + d√©tails</color>
        end
        deactivate EUAPI
        
    and <color:#ffa726>V√©rification ONU</color>
        BlacklistService -> UNAPI : <color:#ffa726>Recherche sanctions ONU</color>
        activate UNAPI
        UNAPI --> BlacklistService : <color:#00ff00>R√©sultat ONU</color>
        deactivate UNAPI
        
    and <color:#ffa726>V√©rification ACPR (France)</color>
        BlacklistService -> ACPRAPI : <color:#ffa726>Recherche sanctions France</color>
        activate ACPRAPI
        ACPRAPI --> BlacklistService : <color:#00ff00>R√©sultat ACPR</color>
        deactivate ACPRAPI
        
    and <color:#ffa726>V√©rification World-Check</color>
        BlacklistService -> WorldCheckAPI : <color:#ffa726>Recherche base commerciale</color>
        activate WorldCheckAPI
        WorldCheckAPI --> BlacklistService : <color:#00ff00>R√©sultat World-Check</color>
        deactivate WorldCheckAPI
    end
    
    == Analyse des R√©sultats ==
    
    BlacklistService -> ScoringService : <color:#96ceb4>Analyze tous les r√©sultats</color>
    activate ScoringService
    
    ScoringService -> ScoringService : <color:#ffa726>Consolider r√©sultats multi-sources</color>
    ScoringService -> ScoringService : <color:#ffa726>Calculate score de risque global</color>
    ScoringService -> ScoringService : <color:#ffa726>Identifier correspondances exactes</color>
    ScoringService -> ScoringService : <color:#ffa726>D√©tecter correspondances partielles</color>
    
    alt <color:#ff6b6b>Correspondance exacte confirm√©e</color>
        ScoringService --> BlacklistService : <color:#ff6b6b>BLACKLIST√â CONFIRM√â: Score 100%</color>
        
        BlacklistService -> KYCDB : <color:#00d2d3>UPDATE client_status='BLACKLISTED', risk_score=100</color>
        activate KYCDB
        KYCDB --> BlacklistService : <color:#00d2d3>Client marqu√© blacklist√©</color>
        deactivate KYCDB
        
        BlacklistService -> AuditService : <color:#feca57>Log blacklist confirm√©</color>
        activate AuditService
        AuditService -> AuditDB : Enregistre blacklist + sources
        deactivate AuditService
        
        BlacklistService -> NotificationService : <color:#ff9ff3>Alerte urgente blacklist</color>
        activate NotificationService
        NotificationService -> Manager : <color:#ff6b6b>üö® URGENT : Client blacklist√© confirm√©</color>
        activate Manager
        NotificationService -> Analyste : <color:#ff6b6b>üö® Client blacklist√© - Action requise</color>
        activate Analyste
        NotificationService --> BlacklistService : <color:#00d2d3>Alertes envoy√©es</color>
        deactivate NotificationService
        
        BlacklistService --> Orchestrator : <color:#ff6b6b>Client blacklist√© - Processus suspendu</color>
        
        note over Manager, Analyste : <color:#ff6b6b>**ACTION IMM√âDIATE REQUISE :**</color>\n<color:#ff6b6b>‚Ä¢ Suspension imm√©diate du compte</color>\n<color:#ff6b6b>‚Ä¢ D√©claration TRACFIN obligatoire</color>\n<color:#ff6b6b>‚Ä¢ Investigation compliance</color>
        
    else <color:#ffa726>Correspondance partielle/incertaine</color>
        ScoringService --> BlacklistService : <color:#ffa726>CORRESPONDANCE PARTIELLE: Score 60-85%</color>
        
        BlacklistService -> PEPService : <color:#96ceb4>Verify statut PEP</color>
        activate PEPService
        PEPService -> PEPService : <color:#ffa726>Analyze exposition politique</color>
        PEPService -> PEPService : <color:#ffa726>Verify relations familiales</color>
        PEPService --> BlacklistService : <color:#96ceb4>Analyse PEP termin√©e</color>
        deactivate PEPService
        
        BlacklistService -> KYCDB : <color:#00d2d3>UPDATE client_status='PENDING_REVIEW', risk_score=?</color>
        activate KYCDB
        KYCDB --> BlacklistService : <color:#00d2d3>Statut mis √† jour</color>
        deactivate KYCDB
        
        BlacklistService -> AuditService : <color:#feca57>Log correspondance partielle</color>
        activate AuditService
        AuditService -> AuditDB : Enregistre alerte + scores
        deactivate AuditService
        
        BlacklistService -> NotificationService : <color:#ff9ff3>Demande r√©vision manuelle</color>
        activate NotificationService
        NotificationService -> Analyste : <color:#ffa726>üîç R√©vision manuelle requise - Correspondance partielle</color>
        NotificationService -> Manager : <color:#ffa726>‚ö†Ô∏è Client en attente de r√©vision</color>
        NotificationService --> BlacklistService : <color:#00d2d3>Demandes envoy√©es</color>
        deactivate NotificationService
        
        BlacklistService --> Orchestrator : <color:#ffa726>R√©vision manuelle requise</color>
        
        note over Analyste : <color:#ffa726>**R√âVISION MANUELLE :**</color>\n<color:#ffa726>‚Ä¢ Analyze correspondances</color>\n<color:#ffa726>‚Ä¢ Verify contexte</color>\n<color:#ffa726>‚Ä¢ D√©cision finale √† prendre</color>
        
    else <color:#00ff00>Aucune correspondance significative</color>
        ScoringService --> BlacklistService : <color:#00ff00>CLEAN: Score < 60%</color>
        deactivate ScoringService
        
        BlacklistService -> KYCDB : <color:#00d2d3>UPDATE client_status='VERIFIED', risk_score=0</color>
        activate KYCDB
        KYCDB --> BlacklistService : <color:#00d2d3>Client v√©rifi√©</color>
        deactivate KYCDB
        
        == Mise en Cache ==
        
        BlacklistService -> CacheService : <color:#54a0ff>Mettre r√©sultats en cache</color>
        activate CacheService
        CacheService -> BlacklistCache : <color:#5f27cd>INSERT blacklist_cache</color>
        activate BlacklistCache
        BlacklistCache --> CacheService : <color:#00d2d3>Cache mis √† jour</color>
        deactivate BlacklistCache
        CacheService --> BlacklistService : <color:#00d2d3>R√©sultats cach√©s</color>
        deactivate CacheService
        
        BlacklistService -> AuditService : <color:#feca57>Log v√©rification clean</color>
        activate AuditService
        AuditService -> AuditDB : Enregistre v√©rification clean
        deactivate AuditService
        
        BlacklistService -> NotificationService : <color:#ff9ff3>Confirmer client clean</color>
        activate NotificationService
        NotificationService -> Manager : <color:#00ff00>‚úÖ Client v√©rifi√© - Aucune correspondance</color>
        NotificationService --> BlacklistService : <color:#00d2d3>Confirmation envoy√©e</color>
        deactivate NotificationService
        
        BlacklistService --> Orchestrator : <color:#00ff00>Client v√©rifi√© - Processus peut continuer</color>
        
        note over Orchestrator : <color:#00ff00>**CLIENT CLEAN :**</color>\n<color:#00ff00>‚Ä¢ Toutes sources v√©rifi√©es</color>\n<color:#00ff00>‚Ä¢ Aucune correspondance</color>\n<color:#00ff00>‚Ä¢ Processus KYC peut continuer</color>
    end
end

deactivate BlacklistService

== Finalisation ==

Orchestrator -> AuditService : <color:#feca57>Log fin v√©rification blacklist</color>
activate AuditService
AuditService -> AuditDB : Enregistre fin + r√©sultat final
AuditService --> Orchestrator : <color:#00d2d3>Processus audit√©</color>
deactivate AuditService

Orchestrator -> Orchestrator : <color:#00ff00>V√©rification blacklist termin√©e</color>
deactivate Orchestrator

deactivate Manager
deactivate Analyste

note over KYCDB : <color:#ffa726>**SOURCES V√âRIFI√âES :**</color>\n<color:#ffa726>‚Ä¢ OFAC (USA)</color>\n<color:#ffa726>‚Ä¢ Union Europ√©enne</color>\n<color:#ffa726>‚Ä¢ ONU</color>\n<color:#ffa726>‚Ä¢ ACPR (France)</color>\n<color:#ffa726>‚Ä¢ World-Check</color>\n<color:#ffa726>‚Ä¢ Listes PEP</color>

@enduml
